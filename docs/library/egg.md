# Egg

## 使用

### Egg-cluster和pm2有什么区别？

egg的cluster相比pm2，代码有所简化，**在传统的Master-worker的基础上，增加了agent**。变为Master-agetn-worker。

在大部分情况下，我们在写业务代码的时候完全不用考虑 Agent 进程的存在，但是**当我们遇到一些场景，只想让代码运行在一个进程上的时候，Agent 进程就到了发挥作用的时候**了。

由于 Agent 只有一个，而且会负责许多维持连接的脏活累活，因此它不能轻易挂掉和重启，所以 Agent 进程在监听到未捕获异常时不会退出，但是会打印出错误日志，我们需要对日志中的未捕获异常提高警惕。

``` bash
                +--------+          +-------+
                | Master +<-------->+ Agent |
                +---+----+          +-------+
                v   ^    v
               /    |     \
             /      |       \
           /        |         \
         ^          v          ^
+--------+-+   +----+-----+   ++---------+
| Worker 1 |   | Worker 2 |   | Worker 3 |
+----------+   +----------+   +----------+

```


参考：

[Egg.js 进程管理为什么没有选型 PM2 ？ - 知乎](https://www.zhihu.com/question/298718190/answer/511704261?from=singlemessage&isappinstalled=0&utm_medium=social&utm_oi=41809770184704&utm_source=wechat_session&s_r=0)

[nest如何实现多进程间通信和egg类似的agent机制 - CNode技术社区](https://cnodejs.org/topic/5b60495e58db3ccf66a450c6)

### Agent的使用场景有哪些？

有些工作其实不需要每个 Worker 都去做，如果都做，一来是浪费资源，更重要的是可能会**导致多进程间资源访问冲突**。举个例子：生产环境的日志文件我们一般会按照日期进行归档，在单进程模型下这再简单不过了：

- 每天凌晨 0 点，将当前日志文件按照日期进行重命名
- 销毁以前的文件句柄，并创建新的日志文件继续写入

试想如果现在是 4 个进程来做同样的事情，是不是就乱套了。所以，对于这一类后台运行的逻辑，我们希望将它们放到一个单独的进程上去执行，这个进程就叫 Agent Worker，简称 Agent。Agent 好比是 Master 给其他 Worker 请的一个『秘书』，它不对外提供服务，只给 App Worker 打工，专门处理一些公共事务。